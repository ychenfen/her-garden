<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>她的花园 - 月经周期模拟器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            color: #fff;
        }
        #canvas-container { width: 100vw; height: 100vh; }

        /* --- 顶部标题 --- */
        #header {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            text-align: center; pointer-events: none; z-index: 100;
        }
        #header h1 {
            font-size: 1.8rem; font-weight: 300; color: #ff8fab;
            letter-spacing: 8px; text-shadow: 0 0 20px rgba(255, 143, 171, 0.5);
        }
        #header p { font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); margin-top: 8px; }

        /* --- 核心：时间控制台 --- */
        #time-control-panel {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 900px;
            background: rgba(26, 26, 46, 0.9); backdrop-filter: blur(12px);
            border-radius: 20px; padding: 24px 32px;
            border: 1px solid rgba(255, 143, 171, 0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 200;
        }

        .cycle-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 20px;
        }
        .cycle-day-container {
            display: flex; align-items: baseline; gap: 12px;
        }
        .cycle-day {
            font-size: 2.5rem; font-weight: bold; color: #ff8fab;
            font-family: 'Helvetica Neue', sans-serif;
        }
        .cycle-phase {
            font-size: 1.3rem; color: #fff; font-weight: 500;
            padding: 4px 12px; border-radius: 20px;
            background: rgba(255,255,255,0.1);
        }
        .cycle-desc {
            font-size: 0.95rem; color: rgba(255,255,255,0.8);
            text-align: right; max-width: 350px; line-height: 1.5;
        }

        /* 激素指示器 */
        .hormone-indicators {
            display: flex; gap: 20px; margin-bottom: 16px;
        }
        .hormone-bar {
            flex: 1; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 14px;
        }
        .hormone-label {
            font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 6px;
            display: flex; justify-content: space-between;
        }
        .hormone-track {
            height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden;
        }
        .hormone-fill {
            height: 100%; border-radius: 3px; transition: width 0.3s ease;
        }
        .estrogen-fill { background: linear-gradient(90deg, #ff8fab, #ff6b9d); }
        .progesterone-fill { background: linear-gradient(90deg, #ffd700, #ffa500); }
        .lh-fill { background: linear-gradient(90deg, #00ffcc, #00cc99); }

        /* 滑块轨道 */
        .slider-container {
            position: relative; margin-top: 10px;
        }
        .phase-labels {
            display: flex; justify-content: space-between; margin-bottom: 8px;
            font-size: 0.7rem; color: rgba(255,255,255,0.5);
        }
        input[type="range"]#cycle-slider {
            width: 100%; -webkit-appearance: none; height: 14px; border-radius: 7px; outline: none;
            background: linear-gradient(to right,
                #ff4d4d 0%, #ff4d4d 18%,
                #ffb6c1 18%, #ffb6c1 46%,
                #ffd700 46%, #ffd700 54%,
                #ffa07a 54%, #ffa07a 100%
            );
            cursor: pointer;
        }
        input[type="range"]#cycle-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%;
            background: #fff; border: 4px solid #ff8fab;
            box-shadow: 0 0 15px rgba(255,143,171,0.6), 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        input[type="range"]#cycle-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(255,143,171,0.8), 0 2px 8px rgba(0,0,0,0.3);
        }
        input[type="range"]#cycle-slider::-moz-range-thumb {
            width: 26px; height: 26px; border-radius: 50%; border: none;
            background: #fff; border: 4px solid #ff8fab;
            box-shadow: 0 0 15px rgba(255,143,171,0.6);
        }

        /* --- 左侧信息面板 --- */
        #info-panel {
            position: absolute; top: 120px; left: 30px; width: 320px;
            background: rgba(26, 26, 46, 0.9); backdrop-filter: blur(10px);
            border-radius: 16px; padding: 24px;
            border: 1px solid rgba(255, 143, 171, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 100;
        }
        #info-panel h2 {
            font-size: 1.1rem; color: #ff8fab; margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        #info-panel h2::before {
            content: ''; width: 4px; height: 20px;
            background: linear-gradient(180deg, #ff0055, #ff8fab); border-radius: 2px;
        }
        #info-panel p { font-size: 0.9rem; line-height: 1.7; color: rgba(255, 255, 255, 0.8); }
        .highlight { color: #ff8fab; font-weight: 500; }

        /* --- 右侧控制面板 --- */
        #control-panel {
            position: absolute; top: 120px; right: 30px; width: 200px;
            background: rgba(26, 26, 46, 0.9); backdrop-filter: blur(10px);
            border-radius: 16px; padding: 20px;
            border: 1px solid rgba(255, 143, 171, 0.2);
            z-index: 100;
        }
        #control-panel h3 {
            color: #ff8fab; margin-bottom: 15px; font-size: 0.95rem;
        }
        .btn {
            display: block; width: 100%; padding: 10px 12px; margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff; border-radius: 8px; cursor: pointer;
            transition: all 0.3s; font-size: 0.85rem;
        }
        .btn:hover {
            background: rgba(255, 143, 171, 0.25);
            border-color: #ff8fab;
            transform: translateY(-2px);
        }
        .btn.active {
            background: linear-gradient(135deg, #ff0055, #ff8fab);
            border-color: transparent;
        }

        /* 播放控制 */
        .playback-controls {
            display: flex; gap: 8px; margin-top: 10px;
        }
        .playback-btn {
            flex: 1; padding: 8px; background: rgba(255,143,171,0.2);
            border: 1px solid rgba(255,143,171,0.3); border-radius: 6px;
            color: #ff8fab; cursor: pointer; transition: 0.3s;
        }
        .playback-btn:hover { background: rgba(255,143,171,0.4); }
        .playback-btn.playing { background: #ff0055; color: #fff; }

        /* 悬浮提示 */
        .tooltip {
            position: absolute; padding: 12px 16px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(255, 143, 171, 0.4); border-radius: 10px;
            color: #fff; font-size: 0.85rem; line-height: 1.5;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 300; max-width: 250px;
        }
        .tooltip.visible { opacity: 1; }
        .tooltip strong { color: #ff8fab; }

        /* 加载动画 */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a2e; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
            transition: opacity 0.5s ease;
        }
        #loading.hidden { opacity: 0; pointer-events: none; }
        .loader {
            width: 60px; height: 60px;
            border: 3px solid rgba(255, 143, 171, 0.2);
            border-top-color: #ff8fab; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-text { margin-top: 20px; color: rgba(255,255,255,0.6); font-size: 0.9rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 排卵特效 */
        .ovulation-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
            pointer-events: none; opacity: 0; z-index: 50;
            transition: opacity 0.5s;
        }
        .ovulation-flash.active { opacity: 1; }

        /* ==================== 移动端适配 (Responsive) ==================== */
        @media screen and (max-width: 768px) {
            /* 1. 调整标题 */
            #header { top: 15px; width: 100%; }
            #header h1 { font-size: 1.3rem; letter-spacing: 4px; }
            #header p { font-size: 0.75rem; }

            /* 2. 底部时间控制器 */
            #time-control-panel {
                width: 94%; bottom: 15px; padding: 14px 16px;
                border-radius: 14px;
            }
            .cycle-header { flex-direction: column; gap: 8px; margin-bottom: 12px; }
            .cycle-day { font-size: 1.6rem; }
            .cycle-phase { font-size: 0.85rem; padding: 3px 10px; }
            .cycle-desc {
                font-size: 0.8rem; max-width: 100%; text-align: left;
                display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2;
                -webkit-box-orient: vertical; overflow: hidden;
            }
            .hormone-indicators { gap: 8px; margin-bottom: 10px; }
            .hormone-bar { padding: 8px 10px; }
            .hormone-label { font-size: 0.65rem; }
            .hormone-label span:first-child {
                max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            }
            .phase-labels { font-size: 0.6rem; }
            input[type="range"]#cycle-slider { height: 12px; }
            input[type="range"]#cycle-slider::-webkit-slider-thumb { width: 22px; height: 22px; }

            /* 3. 左侧信息面板 - 折叠为图标 */
            #info-panel {
                top: 70px; left: 10px; width: 44px; height: 44px;
                padding: 0; overflow: hidden;
                border-radius: 50%; cursor: pointer;
                display: flex; align-items: center; justify-content: center;
                transition: all 0.3s ease;
            }
            #info-panel::after {
                content: 'i'; font-size: 1.1rem; color: #ff8fab; font-weight: bold;
                font-style: italic; font-family: Georgia, serif;
            }
            #info-panel h2, #info-panel p { display: none; }

            #info-panel.expanded {
                width: calc(100% - 20px); height: auto; max-height: 70vh;
                border-radius: 16px; padding: 20px;
                top: 70px; left: 10px;
                overflow-y: auto;
            }
            #info-panel.expanded::after { display: none; }
            #info-panel.expanded h2, #info-panel.expanded p { display: block; }

            /* 4. 右侧控制面板 */
            #control-panel {
                top: 70px; right: 10px; width: auto; min-width: 120px;
                padding: 12px; border-radius: 12px;
            }
            #control-panel h3 { font-size: 0.8rem; margin-bottom: 10px; }
            .btn {
                padding: 8px 10px; font-size: 0.75rem;
                margin-bottom: 6px;
            }
            #btn-anatomy { display: none; }
            .playback-controls { gap: 6px; margin-top: 8px; }
            .playback-btn { padding: 6px; font-size: 0.75rem; }

            /* 5. 提示框适配 */
            .tooltip {
                max-width: 200px; font-size: 0.8rem;
                left: 50% !important; transform: translateX(-50%);
                bottom: 200px; top: auto !important;
            }
        }

        /* 超小屏幕 (iPhone SE 等) */
        @media screen and (max-width: 375px) {
            #header h1 { font-size: 1.1rem; letter-spacing: 2px; }
            .cycle-day { font-size: 1.4rem; }
            .hormone-indicators { flex-direction: column; gap: 6px; }
            #control-panel { min-width: 100px; padding: 10px; }
            .btn { font-size: 0.7rem; padding: 6px 8px; }
        }

        /* 横屏模式 */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            #time-control-panel {
                bottom: 10px; padding: 10px 16px;
                max-height: 40vh;
            }
            .cycle-header { flex-direction: row; }
            .hormone-indicators { display: none; }
            #info-panel { top: 60px; }
            #control-panel { top: 60px; }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div id="loading">
        <div class="loader"></div>
        <div class="loader-text">正在构建生命的节律...</div>
    </div>

    <!-- 排卵闪光特效 -->
    <div class="ovulation-flash" id="ovulation-flash"></div>

    <div id="canvas-container"></div>

    <div id="header">
        <h1>她的花园</h1>
        <p>月经周期模拟器 - 感受28天的生命节律</p>
    </div>

    <div id="info-panel">
        <h2 id="organ-title">时间引擎已启动</h2>
        <p id="organ-description">
            <span class="highlight">拖动底部滑块</span>，观察身体在28天周期中的奇妙变化：
            <br><br>
            <span class="highlight">Day 1-5</span> 月经期：内膜脱落<br>
            <span class="highlight">Day 6-13</span> 卵泡期：卵泡发育<br>
            <span class="highlight">Day 14</span> 排卵日：卵子释放<br>
            <span class="highlight">Day 15-28</span> 黄体期：等待着床
            <br><br>
            点击任意器官查看详情。
        </p>
    </div>

    <div id="control-panel">
        <h3>实验室控制</h3>
        <button class="btn" id="btn-rotate">自动旋转</button>
        <button class="btn" id="btn-reset">重置视角</button>
        <button class="btn" id="btn-anatomy">切换解剖视图</button>
        <div class="playback-controls">
            <button class="playback-btn" id="btn-play">▶ 播放</button>
            <button class="playback-btn" id="btn-speed">1x</button>
        </div>
    </div>

    <div id="time-control-panel">
        <div class="cycle-header">
            <div>
                <div class="cycle-day-container">
                    <div class="cycle-day" id="day-display">Day 1</div>
                    <div class="cycle-phase" id="phase-display">月经期</div>
                </div>
            </div>
            <div class="cycle-desc" id="phase-desc">子宫内膜开始脱落，身体正在重启循环...</div>
        </div>

        <!-- 激素指示器 -->
        <div class="hormone-indicators">
            <div class="hormone-bar">
                <div class="hormone-label">
                    <span>雌激素 (Estrogen)</span>
                    <span id="estrogen-value">20%</span>
                </div>
                <div class="hormone-track">
                    <div class="hormone-fill estrogen-fill" id="estrogen-bar" style="width: 20%"></div>
                </div>
            </div>
            <div class="hormone-bar">
                <div class="hormone-label">
                    <span>孕激素 (Progesterone)</span>
                    <span id="progesterone-value">10%</span>
                </div>
                <div class="hormone-track">
                    <div class="hormone-fill progesterone-fill" id="progesterone-bar" style="width: 10%"></div>
                </div>
            </div>
            <div class="hormone-bar">
                <div class="hormone-label">
                    <span>黄体生成素 (LH)</span>
                    <span id="lh-value">15%</span>
                </div>
                <div class="hormone-track">
                    <div class="hormone-fill lh-fill" id="lh-bar" style="width: 15%"></div>
                </div>
            </div>
        </div>

        <div class="slider-container">
            <div class="phase-labels">
                <span>月经期</span>
                <span>卵泡期</span>
                <span>排卵</span>
                <span>黄体期</span>
            </div>
            <input type="range" id="cycle-slider" min="1" max="28" value="1" step="0.1">
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ==================== 音效引擎 (Web Audio API) ====================
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playPopSound() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            // 音调：从高频滑向低频，模拟水泡破裂声
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(900, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.12);

            // 音量：快速淡出
            gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.12);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.12);
        }

        function playTickSound() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);

            gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.03);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.03);
        }

        // ==================== 全局变量 ====================
        let scene, camera, renderer, controls;
        let organs = {};
        let raycaster, mouse;
        let follicle, follicleTrail;
        let time = 0;
        let isPlaying = false;
        let playbackSpeed = 1;
        let currentDay = 1;
        let hasOvulated = false;

        // 周期数据
        const cycleData = {
            menstruation: {
                label: "月经期",
                labelEn: "Menstruation",
                desc: "子宫内膜脱落出血，这是周期的开始。身体能量较低，建议多休息。",
                color: "#ff4d4d",
                tip: "这几天可以适当补充铁元素"
            },
            follicular: {
                label: "卵泡期",
                labelEn: "Follicular Phase",
                desc: "雌激素上升，一颗优势卵泡正在快速发育。皮肤状态变好，精力充沛！",
                color: "#ffb6c1",
                tip: "适合做有氧运动和重要决定"
            },
            ovulation: {
                label: "排卵日",
                labelEn: "Ovulation",
                desc: "高光时刻！卵子冲破卵巢释放，体温升高约0.5°C，魅力值Max！",
                color: "#ffd700",
                tip: "受孕概率最高的时期"
            },
            luteal: {
                label: "黄体期",
                labelEn: "Luteal Phase",
                desc: "孕激素升高，内膜变得松软准备着床。可能出现PMS症状。",
                color: "#ffa07a",
                tip: "可能会食欲增加、情绪波动"
            }
        };

        // 器官信息
        const organInfo = {
            clitoris: {
                name: '阴蒂复合体 (Clitoral Complex)',
                desc: '这是冰山下的真相！它不只是外部小点，在体内有巨大的"许愿骨"延伸，长达10厘米以上，拥有8000+神经末梢。它是人类唯一纯粹为快乐而存在的器官。'
            },
            uterus: {
                name: '子宫 (Uterus)',
                desc: '孕育生命的温室。观察它随周期变化：月经期颜色暗淡（内膜脱落），黄体期充血饱满（准备着床）。肌肉壁极有弹性，可扩张数十倍。'
            },
            leftOvary: {
                name: '左侧卵巢 (Left Ovary)',
                desc: '储存卵子和分泌激素的地方。看！那颗金色光球就是正在发育的卵泡。女性出生时有约100-200万个原始卵泡，每月只有1个成熟排出。'
            },
            rightOvary: {
                name: '右侧卵巢 (Right Ovary)',
                desc: '左右卵巢通常交替排卵。卵巢的健康直接影响生育能力、皮肤状态和整体活力。它是女性青春的源泉。'
            },
            vagina: {
                name: '阴道 (Vagina)',
                desc: '连接外阴和子宫颈的弹性管道，长约7-10厘米。有强大的自净功能，依靠乳酸杆菌维持酸性环境（pH 3.8-4.5）抑制有害细菌。无需特别冲洗！'
            },
            follicle: {
                name: '卵泡 / 卵子 (Follicle / Ovum)',
                desc: '这颗金色的球就是正在发育的卵泡！它从Day 1开始生长，Day 14左右破裂释放卵子。排卵后，空壳变成黄体，分泌孕激素。'
            }
        };

        // ==================== 初始化 ====================
        function init() {
            // 场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            scene.fog = new THREE.FogExp2(0x1a1a2e, 0.012);

            // 相机
            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 10);

            // 渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 控制器
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 18;
            controls.autoRotate = false;
            controls.autoRotateSpeed = 0.5;

            // 射线检测
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // 灯光
            addLights();

            // 创建模型
            createOrgans();

            // 事件监听
            addEventListeners();

            // 隐藏加载
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 1200);

            // 开始动画
            animate();
        }

        // ==================== 灯光 ====================
        function addLights() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.35);
            scene.add(ambientLight);

            const mainLight = new THREE.DirectionalLight(0xfff5f0, 1.2);
            mainLight.position.set(5, 10, 7);
            mainLight.castShadow = true;
            scene.add(mainLight);

            const fillLight = new THREE.DirectionalLight(0xe8f4ff, 0.4);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            const rimLight = new THREE.DirectionalLight(0xff8fab, 0.6);
            rimLight.position.set(0, -3, -8);
            scene.add(rimLight);

            // 聚光灯照亮卵巢区域
            const spotLight = new THREE.SpotLight(0xffd700, 1, 15, Math.PI / 6, 0.5);
            spotLight.position.set(-3, 5, 3);
            scene.add(spotLight);
        }

        // ==================== 创建器官 ====================
        function createOrgans() {
            const organGroup = new THREE.Group();
            organGroup.name = 'organGroup';

            // --- 子宫 ---
            const uterusShape = new THREE.Shape();
            uterusShape.moveTo(0, -1.2);
            uterusShape.bezierCurveTo(0.8, -1.2, 1.2, -0.3, 1.2, 0.3);
            uterusShape.bezierCurveTo(1.2, 0.9, 0.6, 1.2, 0, 1.2);
            uterusShape.bezierCurveTo(-0.6, 1.2, -1.2, 0.9, -1.2, 0.3);
            uterusShape.bezierCurveTo(-1.2, -0.3, -0.8, -1.2, 0, -1.2);

            const uterusMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xff6b9d,
                emissive: 0xaa4444,
                emissiveIntensity: 0.15,
                roughness: 0.4,
                metalness: 0.1,
                transparent: true,
                opacity: 0.88,
                side: THREE.DoubleSide
            });

            const uterusGeometry = new THREE.ExtrudeGeometry(uterusShape, {
                depth: 0.8,
                bevelEnabled: true,
                bevelThickness: 0.2,
                bevelSize: 0.2,
                bevelSegments: 6
            });
            uterusGeometry.center();

            const uterus = new THREE.Mesh(uterusGeometry, uterusMaterial);
            uterus.position.set(0, 0.5, 0);
            uterus.rotation.x = Math.PI * 0.08;
            uterus.name = 'uterus';
            uterus.userData.type = 'organ';
            uterus.userData.baseScale = { x: 1, y: 1, z: 1 };
            organs.uterus = uterus;
            organGroup.add(uterus);

            // 宫颈
            const cervixGeometry = new THREE.SphereGeometry(0.28, 32, 32);
            cervixGeometry.scale(1, 0.5, 1);
            const cervix = new THREE.Mesh(cervixGeometry, uterusMaterial.clone());
            cervix.position.set(0, -0.35, 0);
            organGroup.add(cervix);

            // --- 卵巢 ---
            const ovaryMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xff8fab,
                emissive: 0xff8fab,
                emissiveIntensity: 0.1,
                roughness: 0.35,
                metalness: 0.1,
                transparent: true,
                opacity: 0.9
            });

            // 左侧卵巢
            const leftOvaryGeometry = new THREE.SphereGeometry(0.42, 32, 32);
            leftOvaryGeometry.scale(1, 0.7, 0.55);
            const leftOvary = new THREE.Mesh(leftOvaryGeometry, ovaryMaterial.clone());
            leftOvary.position.set(-2.1, 0.8, 0);
            leftOvary.name = 'leftOvary';
            leftOvary.userData.type = 'organ';
            organs.leftOvary = leftOvary;
            organGroup.add(leftOvary);

            // 右侧卵巢
            const rightOvaryGeometry = new THREE.SphereGeometry(0.42, 32, 32);
            rightOvaryGeometry.scale(1, 0.7, 0.55);
            const rightOvary = new THREE.Mesh(rightOvaryGeometry, ovaryMaterial.clone());
            rightOvary.position.set(2.1, 0.8, 0);
            rightOvary.name = 'rightOvary';
            rightOvary.userData.type = 'organ';
            organs.rightOvary = rightOvary;
            organGroup.add(rightOvary);

            // --- 卵泡（核心动态元素）---
            const follicleGeometry = new THREE.SphereGeometry(0.15, 32, 32);
            const follicleMaterial = new THREE.MeshStandardMaterial({
                color: 0xffd700,
                emissive: 0xffaa00,
                emissiveIntensity: 1,
                toneMapped: false
            });
            follicle = new THREE.Mesh(follicleGeometry, follicleMaterial);
            follicle.position.set(0, 0, 0.15);
            follicle.scale.setScalar(0.3);
            follicle.name = 'follicle';
            follicle.userData.type = 'organ';
            leftOvary.add(follicle);
            organs.follicle = follicle;

            // 卵泡光晕
            const glowGeometry = new THREE.SphereGeometry(0.25, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0xffd700,
                transparent: true,
                opacity: 0.3
            });
            const follicleGlow = new THREE.Mesh(glowGeometry, glowMaterial);
            follicle.add(follicleGlow);

            // --- 输卵管 ---
            const tubeMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xffc4d6,
                emissive: 0xffc4d6,
                emissiveIntensity: 0.08,
                roughness: 0.5,
                transparent: true,
                opacity: 0.75
            });

            // 左侧输卵管
            const leftTubeCurve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(-0.85, 0.95, 0),
                new THREE.Vector3(-1.2, 1.25, 0.1),
                new THREE.Vector3(-1.65, 1.15, 0.05),
                new THREE.Vector3(-2.0, 0.9, 0)
            ]);
            const leftTubeGeometry = new THREE.TubeGeometry(leftTubeCurve, 32, 0.08, 12, false);
            const leftTube = new THREE.Mesh(leftTubeGeometry, tubeMaterial.clone());
            organGroup.add(leftTube);

            // 右侧输卵管
            const rightTubeCurve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0.85, 0.95, 0),
                new THREE.Vector3(1.2, 1.25, 0.1),
                new THREE.Vector3(1.65, 1.15, 0.05),
                new THREE.Vector3(2.0, 0.9, 0)
            ]);
            const rightTubeGeometry = new THREE.TubeGeometry(rightTubeCurve, 32, 0.08, 12, false);
            const rightTube = new THREE.Mesh(rightTubeGeometry, tubeMaterial.clone());
            organGroup.add(rightTube);

            // 输卵管伞端
            const fimbriaMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xffb6c1,
                emissive: 0xffb6c1,
                emissiveIntensity: 0.15,
                roughness: 0.6,
                transparent: true,
                opacity: 0.65
            });

            [-2.1, 2.1].forEach((x, idx) => {
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI - Math.PI / 2;
                    const fimbriaGeometry = new THREE.ConeGeometry(0.045, 0.18, 8);
                    const fimbria = new THREE.Mesh(fimbriaGeometry, fimbriaMaterial);
                    fimbria.position.set(
                        x + (idx === 0 ? -1 : 1) * Math.cos(angle) * 0.1,
                        0.85 + Math.sin(angle) * 0.08,
                        Math.sin(angle) * 0.08
                    );
                    fimbria.rotation.z = (idx === 0 ? -1 : 1) * (Math.PI / 2 - angle * 0.3);
                    organGroup.add(fimbria);
                }
            });

            // --- 阴道 ---
            const vaginaMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xc9a88e,
                emissive: 0xc9a88e,
                emissiveIntensity: 0.05,
                roughness: 0.5,
                transparent: true,
                opacity: 0.7
            });
            const vaginaGeometry = new THREE.CylinderGeometry(0.25, 0.35, 2, 32, 1, true);
            const vagina = new THREE.Mesh(vaginaGeometry, vaginaMaterial);
            vagina.position.set(0, -1.2, 0);
            vagina.name = 'vagina';
            vagina.userData.type = 'organ';
            organs.vagina = vagina;
            organGroup.add(vagina);

            // --- 阴蒂复合体 ---
            createClitoris(organGroup);

            // --- 骨盆参考 ---
            const pelvisMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xe8ddd4,
                emissive: 0xe8ddd4,
                emissiveIntensity: 0.02,
                roughness: 0.85,
                transparent: true,
                opacity: 0.2,
                wireframe: false
            });

            const pelvisGeometry = new THREE.TorusGeometry(2.6, 0.25, 12, 32, Math.PI);
            const pelvis = new THREE.Mesh(pelvisGeometry, pelvisMaterial);
            pelvis.position.set(0, -0.5, 0);
            pelvis.rotation.x = Math.PI / 2;
            pelvis.rotation.z = Math.PI;
            organGroup.add(pelvis);

            scene.add(organGroup);
        }

        // ==================== 阴蒂复合体 ====================
        function createClitoris(organGroup) {
            const clitorisGroup = new THREE.Group();
            clitorisGroup.name = 'clitoris';
            clitorisGroup.userData.type = 'organ';

            const clitMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xff0055,
                emissive: 0xff0055,
                emissiveIntensity: 0.5,
                roughness: 0.2,
                metalness: 0.15,
                transparent: true,
                opacity: 0.92,
                clearcoat: 1.0,
                clearcoatRoughness: 0.1
            });

            // 阴蒂头
            const glansGeometry = new THREE.SphereGeometry(0.12, 32, 32);
            glansGeometry.scale(1, 0.8, 0.9);
            const glans = new THREE.Mesh(glansGeometry, clitMaterial);
            glans.position.set(0, -0.6, 1.1);
            clitorisGroup.add(glans);

            // 包皮
            const hoodMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xffb6c1,
                emissive: 0xff8fab,
                emissiveIntensity: 0.1,
                roughness: 0.4,
                transparent: true,
                opacity: 0.45
            });
            const hoodGeometry = new THREE.SphereGeometry(0.15, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
            const hood = new THREE.Mesh(hoodGeometry, hoodMaterial);
            hood.position.set(0, -0.55, 1.15);
            hood.rotation.x = Math.PI * 0.3;
            clitorisGroup.add(hood);

            // 阴蒂体
            const bodyPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0, -0.6, 1.0),
                new THREE.Vector3(0, -0.5, 0.7),
                new THREE.Vector3(0, -0.4, 0.4),
                new THREE.Vector3(0, -0.3, 0.2)
            ]);
            const bodyGeometry = new THREE.TubeGeometry(bodyPath, 24, 0.1, 16, false);
            const body = new THREE.Mesh(bodyGeometry, clitMaterial);
            clitorisGroup.add(body);

            // 阴蒂脚
            const leftCrusPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(-0.05, -0.3, 0.2),
                new THREE.Vector3(-0.4, -0.5, 0.1),
                new THREE.Vector3(-0.8, -0.8, -0.1),
                new THREE.Vector3(-1.2, -1.2, -0.3),
                new THREE.Vector3(-1.6, -1.5, -0.5)
            ]);
            const leftCrus = new THREE.Mesh(
                new THREE.TubeGeometry(leftCrusPath, 32, 0.08, 12, false),
                clitMaterial
            );
            clitorisGroup.add(leftCrus);

            const rightCrusPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0.05, -0.3, 0.2),
                new THREE.Vector3(0.4, -0.5, 0.1),
                new THREE.Vector3(0.8, -0.8, -0.1),
                new THREE.Vector3(1.2, -1.2, -0.3),
                new THREE.Vector3(1.6, -1.5, -0.5)
            ]);
            const rightCrus = new THREE.Mesh(
                new THREE.TubeGeometry(rightCrusPath, 32, 0.08, 12, false),
                clitMaterial
            );
            clitorisGroup.add(rightCrus);

            // 前庭球
            const bulbMaterial = clitMaterial.clone();
            bulbMaterial.emissiveIntensity = 0.4;

            const leftBulbPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(-0.35, -0.8, 0.6),
                new THREE.Vector3(-0.45, -1.2, 0.5),
                new THREE.Vector3(-0.4, -1.6, 0.3),
                new THREE.Vector3(-0.35, -2.0, 0.2)
            ]);
            const leftBulb = new THREE.Mesh(
                new THREE.TubeGeometry(leftBulbPath, 24, 0.18, 16, false),
                bulbMaterial
            );
            clitorisGroup.add(leftBulb);

            const rightBulbPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0.35, -0.8, 0.6),
                new THREE.Vector3(0.45, -1.2, 0.5),
                new THREE.Vector3(0.4, -1.6, 0.3),
                new THREE.Vector3(0.35, -2.0, 0.2)
            ]);
            const rightBulb = new THREE.Mesh(
                new THREE.TubeGeometry(rightBulbPath, 24, 0.18, 16, false),
                bulbMaterial
            );
            clitorisGroup.add(rightBulb);

            organGroup.add(clitorisGroup);
            organs.clitoris = clitorisGroup;

            clitorisGroup.traverse((child) => {
                if (child.isMesh) {
                    child.userData.parentName = 'clitoris';
                }
            });
        }

        // ==================== 周期更新核心逻辑 ====================
        function updateCycle(day) {
            currentDay = day;

            // UI 更新
            document.getElementById('day-display').innerText = `Day ${Math.floor(day)}`;

            let phaseKey = '';
            if (day <= 5) phaseKey = 'menstruation';
            else if (day <= 13) phaseKey = 'follicular';
            else if (day <= 15) phaseKey = 'ovulation';
            else phaseKey = 'luteal';

            const data = cycleData[phaseKey];
            const phaseDisplay = document.getElementById('phase-display');
            phaseDisplay.innerText = data.label;
            phaseDisplay.style.background = data.color + '40';
            phaseDisplay.style.color = data.color;
            document.getElementById('phase-desc').innerText = data.desc;

            // 激素水平计算
            let estrogen, progesterone, lh;

            if (day <= 5) {
                estrogen = 15 + (day / 5) * 10;
                progesterone = 5;
                lh = 10;
            } else if (day <= 13) {
                estrogen = 25 + ((day - 5) / 8) * 65;
                progesterone = 5 + ((day - 5) / 8) * 5;
                lh = 10 + ((day - 5) / 8) * 20;
            } else if (day <= 15) {
                const ovProgress = (day - 13) / 2;
                estrogen = 90 - ovProgress * 30;
                progesterone = 10 + ovProgress * 20;
                lh = 30 + ovProgress * 70 * (1 - ovProgress);
            } else {
                const lutealProgress = (day - 15) / 13;
                estrogen = 60 - lutealProgress * 20 + Math.sin(lutealProgress * Math.PI) * 15;
                progesterone = 30 + Math.sin(lutealProgress * Math.PI) * 50;
                lh = 20 - lutealProgress * 10;
            }

            // 更新激素条
            document.getElementById('estrogen-bar').style.width = estrogen + '%';
            document.getElementById('estrogen-value').innerText = Math.round(estrogen) + '%';
            document.getElementById('progesterone-bar').style.width = progesterone + '%';
            document.getElementById('progesterone-value').innerText = Math.round(progesterone) + '%';
            document.getElementById('lh-bar').style.width = lh + '%';
            document.getElementById('lh-value').innerText = Math.round(lh) + '%';

            // 卵泡动画
            updateFollicle(day);

            // 子宫变化
            updateUterus(day);

            // 排卵闪光 + 音效
            if (day >= 13.8 && day <= 14.2 && !hasOvulated) {
                document.getElementById('ovulation-flash').classList.add('active');
                playPopSound(); // 播放排卵音效
                hasOvulated = true;
                setTimeout(() => {
                    document.getElementById('ovulation-flash').classList.remove('active');
                }, 800);
            }
            if (day < 13 || day > 15) {
                hasOvulated = false;
            }
        }

        function updateFollicle(day) {
            if (!follicle) return;

            const leftOvary = organs.leftOvary;

            if (day <= 13) {
                // 卵泡期：生长
                const growth = Math.pow((day - 1) / 12, 0.7);
                follicle.visible = true;
                follicle.scale.setScalar(0.3 + growth * 1.0);
                follicle.position.set(0, 0, 0.15 + growth * 0.25);
                follicle.material.color.setHex(0xffd700);
                follicle.material.emissive.setHex(0xffaa00);
                follicle.material.emissiveIntensity = 0.8 + growth * 0.4;

                // 重置为卵巢的子对象
                if (follicle.parent !== leftOvary) {
                    scene.remove(follicle);
                    leftOvary.add(follicle);
                }
            } else if (day > 13 && day <= 16) {
                // 排卵：飞出
                const progress = (day - 13) / 3;

                if (follicle.parent === leftOvary) {
                    leftOvary.remove(follicle);
                    scene.add(follicle);
                    const worldPos = new THREE.Vector3();
                    leftOvary.getWorldPosition(worldPos);
                    follicle.position.copy(worldPos);
                }

                const startPos = new THREE.Vector3(-2.1, 0.8, 0.4);
                const endPos = new THREE.Vector3(-1.2, 1.1, 0.2);

                follicle.position.lerpVectors(startPos, endPos, progress);
                follicle.scale.setScalar(1.3 - progress * 0.3);
                follicle.material.emissiveIntensity = 1.2 - progress * 0.4;
            } else {
                // 黄体期：变成黄体
                const lutealProgress = (day - 16) / 12;

                if (follicle.parent !== leftOvary) {
                    scene.remove(follicle);
                    leftOvary.add(follicle);
                }

                follicle.position.set(0, 0, 0.2);
                follicle.material.color.setHex(0xffa07a);
                follicle.material.emissive.setHex(0xff6600);
                follicle.scale.setScalar(1.0 - lutealProgress * 0.5);
                follicle.material.emissiveIntensity = 0.8 - lutealProgress * 0.4;
            }
        }

        function updateUterus(day) {
            const uterus = organs.uterus;
            if (!uterus) return;

            if (day <= 5) {
                // 月经期
                uterus.material.color.setHex(0xff7777);
                uterus.material.emissive.setHex(0x550000);
                uterus.material.emissiveIntensity = 0.1;
                uterus.scale.z = 1.0;
            } else if (day <= 14) {
                // 增生期
                const progress = (day - 5) / 9;
                uterus.material.color.setHex(0xff6b9d);
                uterus.material.emissive.setHex(0xaa4444);
                uterus.material.emissiveIntensity = 0.15 + progress * 0.1;
                uterus.scale.z = 1.0 + progress * 0.15;
            } else {
                // 分泌期
                const progress = (day - 14) / 14;
                uterus.material.color.setHex(0xff5577);
                uterus.material.emissive.setHex(0xcc2244);
                uterus.material.emissiveIntensity = 0.25 + Math.sin(progress * Math.PI) * 0.15;
                uterus.scale.z = 1.15 + Math.sin(progress * Math.PI) * 0.1;
            }
        }

        // ==================== 事件监听 ====================
        function addEventListeners() {
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('click', onMouseClick);

            // 滑块
            const slider = document.getElementById('cycle-slider');
            slider.addEventListener('input', (e) => {
                initAudio(); // 首次交互时初始化音频
                updateCycle(parseFloat(e.target.value));
            });

            // 移动端：点击信息面板展开/折叠
            const infoPanel = document.getElementById('info-panel');
            infoPanel.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    e.stopPropagation();
                    infoPanel.classList.toggle('expanded');
                }
            });

            // 点击其他区域关闭展开的面板
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !infoPanel.contains(e.target)) {
                    infoPanel.classList.remove('expanded');
                }
            });

            // 按钮
            document.getElementById('btn-rotate').addEventListener('click', () => {
                controls.autoRotate = !controls.autoRotate;
                document.getElementById('btn-rotate').classList.toggle('active');
            });

            document.getElementById('btn-reset').addEventListener('click', () => {
                camera.position.set(0, 2, 10);
                controls.target.set(0, 0, 0);
            });

            document.getElementById('btn-anatomy').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // 播放控制
            document.getElementById('btn-play').addEventListener('click', function() {
                initAudio(); // 确保音频已初始化
                isPlaying = !isPlaying;
                this.classList.toggle('playing');
                this.textContent = isPlaying ? '⏸ 暂停' : '▶ 播放';
            });

            document.getElementById('btn-speed').addEventListener('click', function() {
                playbackSpeed = playbackSpeed === 1 ? 2 : playbackSpeed === 2 ? 4 : 1;
                this.textContent = playbackSpeed + 'x';
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function onMouseClick(event) {
            raycaster.setFromCamera(mouse, camera);

            const clickables = [];
            Object.values(organs).forEach(organ => {
                if (organ.isMesh) {
                    clickables.push(organ);
                } else if (organ.isGroup) {
                    organ.traverse(child => {
                        if (child.isMesh) clickables.push(child);
                    });
                }
            });

            const intersects = raycaster.intersectObjects(clickables);
            const tooltip = document.getElementById('tooltip');

            if (intersects.length > 0) {
                let target = intersects[0].object;
                let name = target.name || target.userData.parentName;

                const info = organInfo[name];
                if (info) {
                    tooltip.innerHTML = `<strong>${info.name}</strong><br><br>${info.desc}`;
                    tooltip.style.left = Math.min(event.clientX + 15, window.innerWidth - 270) + 'px';
                    tooltip.style.top = Math.min(event.clientY + 15, window.innerHeight - 200) + 'px';
                    tooltip.classList.add('visible');

                    setTimeout(() => tooltip.classList.remove('visible'), 5000);
                }
            } else {
                tooltip.classList.remove('visible');
            }
        }

        // ==================== 动画循环 ====================
        function animate() {
            requestAnimationFrame(animate);

            time += 0.016;
            controls.update();

            // 自动播放
            if (isPlaying) {
                const slider = document.getElementById('cycle-slider');
                let newDay = parseFloat(slider.value) + 0.02 * playbackSpeed;
                if (newDay > 28) newDay = 1;
                slider.value = newDay;
                updateCycle(newDay);
            }

            // 阴蒂呼吸动画
            if (organs.clitoris) {
                const pulse = Math.sin(time * 3) * 0.15 + 0.45;
                organs.clitoris.traverse(child => {
                    if (child.isMesh && child.material) {
                        child.material.emissiveIntensity = pulse;
                    }
                });
            }

            // 卵泡光晕动画
            if (follicle && follicle.children[0]) {
                const glowPulse = Math.sin(time * 4) * 0.1 + 0.3;
                follicle.children[0].material.opacity = glowPulse;
                follicle.children[0].scale.setScalar(1.2 + Math.sin(time * 3) * 0.15);
            }

            // 卵巢轻微浮动
            if (organs.leftOvary) {
                organs.leftOvary.position.y = 0.8 + Math.sin(time * 1.2) * 0.04;
            }
            if (organs.rightOvary) {
                organs.rightOvary.position.y = 0.8 + Math.sin(time * 1.2 + Math.PI) * 0.04;
            }

            renderer.render(scene, camera);
        }

        // ==================== 启动 ====================
        init();
        updateCycle(1);
    </script>
</body>
</html>
